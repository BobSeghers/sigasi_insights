---
title: "No VHDL Rename in Emacs VHDL mode"
layout: page 
pager: true
author: philippe.faes (Sigasi)
date: 2011-06-15
tags: 
  - code reuse
  - Emacs
  - VHDL
---
<div class="content">
<p>In my series of <a href="/content/why-emacs-so-great-and-why-we-want-beat-it">how Sigasi is better than the Emacs <span class="caps">VHDL</span> mode</a>, this entry deals with code reuse, more specifically with <em>renaming</em>.</p>	<h2>Code Reuse</h2>	<p>The situation where you write code once, produce a chip and never look at that code again is pretty rare. Usually, there is going to be a follow-up project. You might build an improved version of the chip, or you might want to reuse an old component for a completely new chip. </p>	<p>It turns out that reuse of hardware designs is not straightforward. You could try to create a library of components and reuse them without any modification. This <em>black box reuse</em> is common in software land. Hardware designers usually call this reusable IP blocks. However, this requires that the blocks are designed with reuse in mind. Usually, you would encounter blocks that were not designed for reuse. You will need to modify some internals of you legacy code, either to improve timing or resource usage, or to alter the behavior for your new specifications. This kind of <em>white box reuse</em>, involves a lot of code inspection and a lot of small modifications to the code. It is a tiresome and error prone process. You are going to need all the help you can get.</p>	<p>There are some important features for code comprehension and <a href="/content/navigating-through-vhdl-project-emacs-vs-sigasi">code navigation</a> that you will need in order to be efficient at reusing your legacy code. Then there is the act of modifying the code. There are three things I want to talk about: naming conventions, cleaning up code layout and code encapsulation. For today, let's stick to naming conventions.</p>	<h2>Global Rename</h2>	<p>Suppose you have some legacy code that uses the signal <code>clock</code> instead of your corporate standard <code>clk</code>. It would be better for all of the code to have a uniform look, so you want to fix this. Even more importantly, your scripts (for building, documenting and preprocessing) rely on the specific name <code>clk</code>, so you <em>need</em> to fix this.</p>	<p>You might be a good scripter, so you write a oneliner that replaces <code>clock</code> with <code>clk</code> in all of your <span class="caps">VHDL</span> files:<br/><code>sed -i -e 's/clock/clk/' *.vhd</code><br/>This looks OK, but there are several ways a global search-and-replace can go wrong:<br/></p><div class="geshifilter"><pre class="vhdl geshifilter-vhdl" style="font-family:monospace;">  <span style="color: #7f0055; font-weight: bold;">signal</span> clkwise <span style="color: #000066;">:</span> <span style="color: #808000;">std_logic</span><span style="color: #000066;">;</span> <span style="color: #3f7f5f;">-- indicate if we rotate the data clkwise</span>  <span style="color: #7f0055; font-weight: bold;">signal</span> clk <span style="color: #000066;">:</span> <span style="color: #808000;">std_logic</span><span style="color: #000066;">;</span> <span style="color: #3f7f5f;">-- clk for main clk domain</span>  <span style="color: #7f0055; font-weight: bold;">signal</span> pci_clk <span style="color: #000066;">:</span> <span style="color: #808000;">std_logic</span><span style="color: #000066;">;</span> <span style="color: #3f7f5f;">-- clk for PCI clk domain</span></pre></div>	<p>I'm sure you can create a script that only replaces the word <code>clock</code> if it is surrounded by white space or by punctuation marks, and not if it is a line comment. Your next problem will be supporting multi-line comments. The point is: <span class="caps">VHDL</span> Emacs does not do all of this for you; you're on your own. If you are a really nice guy you might read this, script a new <a href="http://www.gnu.org/software/emacs/emacs-lisp-intro/" class="elf-external elf-icon">elisp</a> command and send it to <a href="http://www.iis.ee.ethz.ch/~zimmi/emacs/vhdl-mode.html" class="elf-external elf-icon">Reto</a> to be incorporated in the next update of the Emacs <span class="caps">VHDL</span> mode. Let's see if your new improvement would solve the next problem.</p>	<h2>Specific Renaming</h2>	<p>Reusing legacy code, you could be facing a design where all modules name their main input signal <code>data_in</code>. This is not helpful if you try to read it. You want to change these names to something like: <code>temperature_in</code>, <code>video_in</code>, <code>mode_in</code> or whatever. Global search and replace will not help you because you need to be surgically accurate in replacing the correct names, perhaps in dozens of files. Not only will <code>sed</code> be wildly insufficient. So will any reasonable amount of lisp scripting. The same word can mean different things in a single file; even on the same line in a single file. If your script doesn't have all <span class="caps">VHDL</span> scoping rules figured out, it won't work.</p>	<p>You've guessed what I'm about to say next: Sigasi <span class="caps">HDT</span> <em>solves</em> this problem. There's a <a href="/screencast/rename">two minute screencast</a> that demonstrates our rename refactoring. We can do this because Sigasi <span class="caps">HDT</span> analyzes the entire <span class="caps">VHDL</span> project and tries to find the declaration for every name it encounters. </p>	<h2>Not Just a Missing Feature</h2>	<p>As I did in most of my <a href="/emacs">previous posts on Emacs <span class="caps">VHDL</span></a>, I have pointed out a <em>fundamental</em> limitation in Emacs, not just a missing feature. Certain extremely useful operations, like navigation and renaming, require a full blown <span class="caps">VHDL</span> parser. The Emacs <span class="caps">VHDL</span> mode goes a long way using regular expressions. It is indeed surprising to see how many cool things Reto was able to pull of with regex matching. But it will be hard to take this technology one step further. And it will be impossible to take it two or three steps further.</p>	<h2>Disclaimer</h2>	<p>Sigasi's rename refactoring is still inaccurate in some cases: for functions, procedures and enumeration literals. This is because these elements can have their names <a href="http://en.wikipedia.org/wiki/Method_overloading" class="elf-external elf-icon">overloaded</a>. This is, however not a fundamental limitation. It is just something we haven't gotten around to yet.</p>  <div id="book-navigation-1518" class="book-navigation">            <div class="page-links clear-block">              <a href="/content/emacs-syntax-errors" class="page-previous" title="Go to previous page">&#8249; Emacs Syntax errors</a>                    <a href="/better-emacs-vhdl-mode" class="page-up" title="Go to parent page">up</a>                    <a href="/content/no-vhdl-libraries-emacs-vhdl-mode" class="page-next" title="Go to next page">No VHDL Libraries in Emacs VHDL mode &#8250;</a>          </div>      </div>  </div>

